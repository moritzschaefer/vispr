{% extends "layout.html" %}
{% block content %}

<div class="row">
    <div class="col-md-6">
        <h4>Results for {{ selection }} selection</h4>
        <table id="targets" class="table table-striped">
            <thead>
                <th data-dynatable-column="target">Target</th>
                <th data-dynatable-column="score">RRA-score</th>
                <th data-dynatable-column="p-value">p-value</th>
                <th data-dynatable-column="fdr">FDR</th>
                <th style="text-align: right;" data-dynatable-no-sort="true">
                    <div class="dropdown">
                        <button class="btn btn-default dropdown-toggle" type="button" id="selection-menu" data-toggle="dropdown" aria-expanded="true">
                            Selection
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="selection-menu">
                            {% if screen.is_genes %}
                            <li role="presentation"><a id="btn-genemania" role="menuitem" tabindex="-1" href="#">Show in GeneMANIA</a></li>
                            {% endif %}
                            <li role="presentation"><a id="btn-deselect" role="menuitem" tabindex="-1" href="#">Deselect all</a></li>
                        </ul>
                    </div>
                </th>
            <thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="col-md-6">
        <div class="row">
            <div class="col-md-12">
                <h4>p-values</h4>
                <div class="text-center">
                    <div id="score-plot" class="plot"></div>
                    <div id="pval-hist-plot" class="plot"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h4>gRNAs</h4>
                    <div id="rna-plot" class="parcoords" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

        <script>

        var plt_pval = null;
        var plt_rna = null;
        var selected = {};
        var sample_order = null;

        function get_selected() {
            var targets = [];
            for(target in selected) {
                targets.push(target);
            }
            return targets;
        }

        vg.parse.spec("/plt/pvals/{{ screen.name }}/{{ selection }}", function(chart) {
            plt_pval = vega_draw(chart, "#score-plot");
        });


        function update_pval_highlights() {
            var selected = get_selected();
            if(selected.length == 0) {
                plt_pval.data({ "highlight": [] });
                plt_pval.update();
            }
            else {
                d3.json("/tbl/pvals_highlight/{{ screen.name }}/{{ selection }}/" + selected.join("|"), function(error, json) {
                    plt_pval.data(
                        { "highlight": json }
                    );
                    plt_pval.update();
                });
            }
        }

        function clear_pval_highlights() {
            plt_pval.data({"highlight": []});
            plt_pval.update();
        }

        vg.parse.spec("/plt/pvalhist/{{ screen.name }}/{{ selection }}", function(chart) {
            vega_draw(chart, "#pval-hist-plot");
        });

        var dt = $("#targets").dynatable({
            dataset: {
                ajax: true,
                ajaxUrl: "/tbl/targets/{{ screen.name }}/{{ selection }}?{{ table_args|safe }}",
                ajaxOnLoad: true,
                perPageDefault: 20,
                records: [],
                inputs: {
                    paginationClass: 'pagination',
                    paginationActiveClass: 'active',
                    paginationDisabledClass: 'disabled'
                }
            }
        });
        var filters = $("#dynatable-query-search-targets").addClass("form-control").css("margin-right", "2px").parent();
        filters.addClass("form-inline").css("margin-right", "8px");

        {% if control_targets %}
            filters.append('<div class="btn-group" data-toggle="buttons"><label class="btn btn-default"><input type="checkbox" id="hide-controls">hide controls</label></div>');
            {% if hide_control_targets %}
                $("#hide-controls").click();
            {% endif %}
            $("#hide-controls").change(function() {
                if(this.checked) {
                    $.get("/set/hide_control_targets/1", function() {
                        dt.data('dynatable').process();
                    });
                }
                else {
                    $.get("/set/hide_control_targets/0", function() {
                        dt.data('dynatable').process();
                    });
                }
            });
        {% endif %}

        $("#dynatable-per-page-targets").addClass("selectpicker");

        // Perform actions when paging the table.
        dt.on("dynatable:afterUpdate", function() {
            {% if screen.is_genes %}
            $("#targets tr td:first-child").each(function(idx, cell) {
                var target = $(cell).html();
                $(cell).html(
                    '<a target="_blank" href="http://www.ensembl.org/{{ screen.species }}/Gene/Summary?g=' +
                    target + '">' + target + '</a>'
                );
            });
            {% endif %}

            $("#targets tr td:last-child").each(function(idx, cell) {
                var target = $(cell).parent().children(":first").children(":first").html();
                $(cell).html(
                    '<div class="btn-group" role="group">' +
                    '<button type="button" class="btn btn-default btn-plt-rnas" name="' +
                    target + '"><span class="glyphicon glyphicon-stats"></span></button>' +
                    '<button type="button" class="btn btn-default btn-select-target" name="' +
                    target + '"><span class="glyphicon glyphicon-ok"></span></button>' +
                    '</div>'
                );
            });


            // Display parallel coordinates plot of RNA counts.
            $(".btn-plt-rnas").tooltip().click(function() {
                var target = $(this).attr("name");

                $(".btn-plt-rnas").removeClass("active");
                $(this).addClass("active");

                d3.json("/tbl/rnas/{{ screen.name }}/" + target, function(error, data) {
                    if (error) return console.warn(error);
                    $("#rna-plot").empty();

                    var names = data.map(function(rec) { return rec.sgRNA });
                    var dimensions = d3.keys(data[0]);
                    var colors = d3.scale.category10().domain(names);

                    plt_rna = d3.parcoords(
                            {
                                dimensionTitleRotation: -45,
                            }
                        )("#rna-plot")
                        .data(data)
                        .margin({ top: 80, left: 80, bottom: 12, right: 0 })
                        .height(Math.max(data.length * 12, 300))
                        .color(function(record) { return colors(record.sgRNA) })
                        .render();

                    var max_count = 0;
                    dimensions.forEach(function(d) {
                        if(d != "efficiency" && d != "chrom pos" && d != "sgRNA") {
                            max_count = Math.max(max_count, d3.max(data, function(rec) { return rec[d] }));
                        }
                    });
                    dimensions.forEach(function(d) {
                        if(d != "efficiency" && d != "chrom pos" && d != "sgRNA") {
                            plt_rna.scale(d, [0, max_count]);
                        }
                    });

                    plt_rna.createAxes()
                        .brushMode("1D-axes")
                        .reorderable()
                        .interactive()
                        .render();



                    if(sample_order != null) {
                        plt_rna.dimensions(sample_order);
                    }

                    plt_rna.on("render", function() {
                        sample_order = plt_rna.dimensions();
                    });

                    plt_rna.svg.selectAll("text").style("font-size", "10px");
                    $("#rna-plot svg .axis > :contains(sgRNA)").css("opacity", "0");
                    $("#rna-plot svg .axis > :contains(sgRNA)").parent().find(".domain").css("opacity", "0");
                    $("#rna-plot svg .axis > :contains(sgRNA)").parent().find(".tick line").css("opacity", "0");
                    $("#rna-plot svg .axis .label").attr("text-anchor", "left");
                });
            });

            // Display gene in hockey stick and update "selected".
            $(".btn-select-target").tooltip().click(function() {
                var target = $(this).attr("name"); //$(this).parent().parent().children(":first").children(":first").html();

                if(!$(this).hasClass("active")) {
                    $(this).addClass("active");
                    selected[target] = true;
                    update_pval_highlights();
                }
                else {
                    $(this).removeClass("active");
                    delete selected[target];
                    $(this).blur();
                    update_pval_highlights();
                }
            });

            for(target in selected) {
                $("button[name=" + target + "]").addClass("active");
            }

            $(".btn-plt-rnas:first").click();
        });

        // Show selected genes in GeneMANIA.
        $("#btn-genemania").click(function() {
            var url = "http://genemania.org/link?o=human&g=";
            window.open(encodeURI(url + get_selected().join("|")), '_blank');
        });

        // Deselect all genes.
        $("#btn-deselect").click(function() {
            for(target in selected) {
                delete selected[target];
            }
            clear_pval_highlights();
            $(".btn-select-target").removeClass("active");
        });

        </script>
        {% endblock %}
